generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id                    String                @id
  name                  String
  description           String?
  isActive              Boolean               @default(true) @map("is_active")
  createdAt             DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  featuresJson          String?               @default("[]") @map("features_json") // Modular Features: ['finance', 'attendance']
  
  // New: Advanced Configuration
  workStrategy          String                @default("FIXED") @map("work_strategy") // FIXED, SHIFT, FLEXIBLE
  radiusTolerance       Int                   @default(50) @map("radius_tolerance") // Meters
  lateGracePeriod       Int                   @default(15) @map("late_grace_period") // Minutes

  accessList            TenantAccess[]        // Multi-Tenant Access
  attendance            Attendance[]
  businessUnits         BusinessUnit[]
  chartOfAccounts       ChartOfAccount[]
  chatRooms             ChatRoom[]
  dailyReports          DailyReport[]
  financialAccounts     FinancialAccount[]
  leaveRequests         LeaveRequest[]
  projects              Project[]
  settings              Settings?
  transactionCategories TransactionCategory[]
  transactions          Transaction[]
  users                 User[]
  shifts                Shift[]               // Relation to Shifts

  @@map("tenants")
}

model Shift {
  id            String   @id
  tenantId      String   @map("tenant_id")
  name          String
  startTime     String   @map("shift_start_time") // HH:mm
  endTime       String   @map("shift_end_time")   // HH:mm
  isOvernight   Boolean  @default(false) @map("is_overnight")
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  attendance    Attendance[]

  @@map("shifts")
}

model TenantAccess {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  tenantId  String   @map("tenant_id")
  role      String   @default("STAFF") // OWNER, MANAGER, STAFF, FINANCE
  isActive  Boolean  @default(true) @map("is_active")
  
  // Performance: Keep these for quick reference if using FIXED strategy
  shiftStartTime String? @map("shift_start_time") // HH:mm
  shiftEndTime   String? @map("shift_end_time")   // HH:mm
  
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId]) // Prevent duplicate roles
  @@map("tenant_access")
}

model User {
  id               String          @id
  name             String?
  username         String?         @unique
  telegramId       String?         @map("telegram_id")
  telegramUsername String?         @map("telegram_username")
  role             String?         // Legacy Role (for Backward Compat)
  passwordHash     String?         @map("password_hash")
  deviceIds        Json?           @default("[]") @map("device_ids")
  avatarUrl        String?         @map("avatar_url")
  jobTitle         String?         @map("job_title")
  bio              String?
  isFreelance      Boolean?        @default(false) @map("is_freelance")
  createdAt        DateTime?       @default(now()) @map("created_at") @db.Timestamptz(6)
  deviceId         String?         @map("device_id")
  tenantId         String?         @default("sdm") @map("tenant_id")
  
  tenantAccess     TenantAccess[]  // New Relation
  attendance       Attendance[]
  chatMemberships  ChatMember[]
  sentMessages     ChatMessage[]
  dailyReports     DailyReport[]
  requests         LeaveRequest[]
  payrollRecords   PayrollRecord[]
  salaryConfig     SalaryConfig?
  pushSubscriptions PushSubscription[]
  tenant           Tenant?         @relation(fields: [tenantId], references: [id])

  @@map("users")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model Settings {
  officeLat           Float?  @map("office_lat")
  officeLng           Float?  @map("office_lng")
  officeStartTime     String? @map("office_start_time")
  officeEndTime       String? @map("office_end_time")
  hasOvernightShift   Boolean? @default(false) @map("has_overnight_shift")
  telegramBotToken    String? @map("telegram_bot_token")
  telegramGroupId     String? @map("telegram_group_id")
  telegramOwnerChatId String? @map("telegram_owner_chat_id")
  companyProfileJson  String? @map("company_profile_json")
  dailyRecapTime      String? @default("18:00") @map("daily_recap_time") @db.VarChar(10)
  dailyRecapContent   String? @default("[]") @map("daily_recap_content")
  id                  Int     @id @default(autoincrement())
  tenantId            String  @unique @default("sdm") @map("tenant_id")
  tenant              Tenant  @relation(fields: [tenantId], references: [id])

  @@map("settings")
}

model Project {
  id                String    @id
  title             String?
  description       String?
  status            String?
  priority          String?
  deadline          DateTime? @db.Timestamp(6)
  tasksJson         String?   @map("tasks_json")
  collaboratorsJson String?   @map("collaborators_json")
  commentsJson      String?   @map("comments_json")
  isManagementOnly  Int?      @default(0) @map("is_management_only")
  createdBy         String?   @map("created_by")
  createdAt         BigInt?   @map("created_at")
  tenantId          String?   @default("sdm") @map("tenant_id")
  tenant            Tenant?   @relation(fields: [tenantId], references: [id])

  @@map("projects")
}

model Attendance {
  id                String    @id
  userId            String?   @map("user_id")
  date              String?   @db.VarChar(50)
  timeIn            String?   @map("time_in")
  timeOut           String?   @map("time_out")
  isLate            Int?      @map("is_late")
  lateReason        String?   @map("late_reason")
  selfieUrl         String?   @map("selfie_url")
  checkoutSelfieUrl String?   @map("checkout_selfie_url")
  locationLat       Float?    @map("location_lat")
  locationLng       Float?    @map("location_lng")
  createdAt         DateTime? @map("created_at") @db.Timestamptz(6)
  tenantId          String?   @default("sdm") @map("tenant_id")
  
  // New: Advanced Attendance Tracking
  shiftId           String?   @map("shift_id")
  workDuration      Int?      @map("work_duration") // Minutes (for Flexible Strategy)
  
  tenant            Tenant?   @relation(fields: [tenantId], references: [id])
  user              User?     @relation(fields: [userId], references: [id])
  shift             Shift?    @relation(fields: [shiftId], references: [id])

  @@index([tenantId, createdAt(sort: Desc)], map: "idx_attendance_tenant_date")
  @@map("attendance")
}

model LeaveRequest {
  id            String    @id
  userId        String?   @map("user_id")
  type          String?
  description   String?
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  attachmentUrl String?   @map("attachment_url")
  status        String?
  approverId    String?   @map("approver_id")
  approverName  String?   @map("approver_name")
  actionNote    String?   @map("action_note")
  createdAt     BigInt?   @map("created_at")
  actionAt      BigInt?   @map("action_at")
  tenantId      String?   @default("sdm") @map("tenant_id")
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])
  user          User?     @relation(fields: [userId], references: [id])

  @@map("leave_requests")
}

model BusinessUnit {
  id           String        @id
  name         String
  description  String?
  isActive     Boolean?      @default(true) @map("is_active")
  createdAt    BigInt?       @map("created_at")
  tenantId     String?       @default("sdm") @map("tenant_id")
  tenant       Tenant?       @relation(fields: [tenantId], references: [id])
  transactions Transaction[]

  @@map("business_units")
}

model TransactionCategory {
  id        String                @id
  name      String
  type      String
  parentId  String?               @map("parent_id")
  createdAt BigInt?               @map("created_at")
  tenantId  String?               @default("sdm") @map("tenant_id")
  parent    TransactionCategory?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children  TransactionCategory[] @relation("CategoryToCategory")
  tenant    Tenant?               @relation(fields: [tenantId], references: [id])

  @@map("transaction_categories")
}

model ChartOfAccount {
  id           String        @id
  code         String
  name         String
  type         String
  description  String?
  isActive     Boolean?      @default(true) @map("is_active")
  createdAt    BigInt?       @map("created_at")
  normalPos    String?       @map("normal_pos")
  tenantId     String?       @default("sdm") @map("tenant_id")
  tenant       Tenant?       @relation(fields: [tenantId], references: [id])
  transactions Transaction[]

  @@unique([tenantId, code])
  @@map("chart_of_accounts")
}

model FinancialAccount {
  id            String        @id
  name          String
  bankName      String        @map("bank_name")
  accountNumber String?       @map("account_number")
  description   String?
  isActive      Boolean?      @default(true) @map("is_active")
  createdAt     BigInt?       @map("created_at")
  balance       Decimal       @default(0)
  tenantId      String?       @default("sdm") @map("tenant_id")
  tenant        Tenant?       @relation(fields: [tenantId], references: [id])
  transactions  Transaction[]

  @@map("financial_accounts")
}

model Transaction {
  id               String            @id
  date             DateTime?         @db.Date
  amount           Decimal?
  type             String?
  category         String?
  description      String?
  account          String?
  imageUrl         String?           @map("image_url")
  businessUnitId   String?           @map("business_unit_id")
  accountId        String?           @map("account_id")
  isReconciled     Boolean?          @default(false) @map("is_reconciled")
  createdAt        DateTime?         @default(now()) @map("created_at") @db.Timestamptz(6)
  coaId            String?           @map("coa_id")
  contactName      String?           @map("contact_name")
  dueDate          DateTime?         @map("due_date") @db.Date
  status           String?           @default("PAID")
  tenantId         String?           @default("sdm") @map("tenant_id")
  financialAccount FinancialAccount? @relation(fields: [accountId], references: [id])
  businessUnit     BusinessUnit?     @relation(fields: [businessUnitId], references: [id])
  coa              ChartOfAccount?   @relation(fields: [coaId], references: [id])
  tenant           Tenant?           @relation(fields: [tenantId], references: [id])

  @@index([businessUnitId], map: "idx_trans_biz_unit")
  @@index([accountId], map: "idx_trans_account")
  @@index([coaId], map: "idx_trans_coa")
  @@index([tenantId, date(sort: Desc)], map: "idx_transactions_tenant_date")
  @@map("transactions")
}

model DailyReport {
  id             String    @id
  userId         String?   @map("user_id")
  date           String?   @db.VarChar(50)
  activitiesJson String?   @map("activities_json")
  createdAt      DateTime? @map("created_at") @db.Timestamptz(6)
  tenantId       String?   @default("sdm") @map("tenant_id")
  tenant         Tenant?   @relation(fields: [tenantId], references: [id])
  user           User?     @relation(fields: [userId], references: [id])

  @@index([tenantId, createdAt(sort: Desc)], map: "idx_daily_reports_tenant_date")
  @@map("daily_reports")
}

model SalaryConfig {
  userId        String   @id @map("user_id")
  basicSalary   Decimal? @map("basic_salary")
  allowance     Decimal?
  mealAllowance Decimal? @map("meal_allowance")
  lateDeduction Decimal? @map("late_deduction")
  user          User     @relation(fields: [userId], references: [id])

  @@map("salary_configs")
}

model PayrollRecord {
  id                 String   @id
  userId             String?  @map("user_id")
  month              String?
  basicSalary        Decimal? @map("basic_salary")
  allowance          Decimal?
  totalMealAllowance Decimal? @map("total_meal_allowance")
  bonus              Decimal?
  deductions         Decimal?
  netSalary          Decimal? @map("net_salary")
  isSent             Int?     @default(0) @map("is_sent")
  metadataJson       String?  @map("metadata_json")
  createdAt          BigInt?  @map("created_at")
  processedAt        BigInt?  @map("processed_at")
  user               User?    @relation(fields: [userId], references: [id])

  @@map("payroll_records")
}

model SystemLog {
  id           String  @id
  timestamp    BigInt  @map("timestamp")
  actorId      String? @map("actor_id")
  actorName    String? @map("actor_name")
  actorRole    String? @map("actor_role")
  actionType   String? @map("action_type")
  details      String?
  targetObj    String? @map("target_obj")
  metadataJson String? @map("metadata_json")
  tenantId     String? @default("sdm") @map("tenant_id")

  @@map("system_logs")
}

model ChatRoom {
  id        String        @id
  name      String?
  type      String?
  createdBy String?       @map("created_by")
  createdAt BigInt?       @map("created_at")
  tenantId  String?       @default("sdm") @map("tenant_id")
  members   ChatMember[]
  messages  ChatMessage[]
  tenant    Tenant?       @relation(fields: [tenantId], references: [id])

  @@map("chat_rooms")
}

model ChatMember {
  roomId     String   @map("room_id")
  userId     String   @map("user_id")
  lastReadAt BigInt?  @map("last_read_at")
  isPinned   Boolean? @default(false) @map("is_pinned")
  joinedAt   BigInt?  @map("joined_at")
  room       ChatRoom @relation(fields: [roomId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id([roomId, userId])
  @@map("chat_members")
}

model ChatMessage {
  id            String    @id
  roomId        String?   @map("room_id")
  senderId      String?   @map("sender_id")
  content       String?
  attachmentUrl String?   @map("attachment_url")
  replyToId     String?   @map("reply_to_id")
  isPinned      Boolean?  @default(false) @map("is_pinned")
  createdAt     BigInt?   @map("created_at")
  room          ChatRoom? @relation(fields: [roomId], references: [id])
  sender        User?     @relation(fields: [senderId], references: [id])
  replyTo       ChatMessage? @relation("ReplyTo", fields: [replyToId], references: [id])
  replies       ChatMessage[] @relation("ReplyTo")

  @@map("chat_messages")
}
